{% extends 'base.html' %}
{% block title %}Health Plans{% endblock %}
{% block content %}
<h2>Available Health Plans</h2>
<div class="row">
    {% for plan in plans %}
    <div class="col-md-4">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">{{ plan.name }}</h5>
                <p class="card-text">{{ plan.description }}</p>
                <p><strong>Price:</strong> {{ plan.price }} HLT</p>
                <a href="{% url 'purchase-plan' plan.id %}" class="btn btn-primary">Buy Now</a>
            </div>
        </div>
    </div>
    {% endfor %}
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    $(document).ready(function () {
        $(".buy-plan").click(function (event) {
            event.preventDefault();
            let planId = $(this).data("id");
            
            // Show loading animation
            $("#loading").show();
            
            $.ajax({
                url: "/api/purchase-plan/",
                type: "POST",
                data: { 
                    plan_id: planId, 
                    csrfmiddlewaretoken: "{{ csrf_token }}"
                },
                success: function (response) {
                    $("#loading").hide();
                    $("#message").text(response.message).show().addClass("alert alert-success");
                },
                error: function (xhr) {
                    $("#loading").hide();
                    $("#message").text("Error: " + xhr.responseText).show().addClass("alert alert-danger");
                }
            });
        });
    });
</script>

<div id="loading" style="display: none;">Loading...</div>
<div id="message" style="display: none;"></div>

{% for plan in plans %}
    <button class="btn btn-primary buy-plan" data-id="{{ plan.id }}">Buy {{ plan.name }}</button>
{% endfor %}
{% endblock %}